<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Group Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide React icons as inline SVG components
        const UserPlus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="19" y1="8" x2="19" y2="14"></line>
                <line x1="22" y1="11" x2="16" y2="11"></line>
            </svg>
        );
        
        const UserMinus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="22" y1="11" x2="16" y2="11"></line>
            </svg>
        );
        
        const Users = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );
        
        const AlertCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );
        
        const CheckCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );
        
        const Loader2 = () => (
            <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
        );

        function GoogleGroupManager() {
            const [members, setMembers] = useState([]);
            const [emailInput, setEmailInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [accessToken, setAccessToken] = useState(null);

            const GROUP_EMAIL = 'client-onboarding@progroupmail.com';
            
            // IMPORTANT: Replace these with your actual credentials
            const CLIENT_ID = '781550108214-t33edugggk22o5uk0r1h8k48v9qbcbgd.apps.googleusercontent.com';

            useEffect(() => {
                // Initialize Google Identity Services
                const initializeGIS = () => {
                    window.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/admin.directory.group.member',
                        callback: (response) => {
                            if (response.access_token) {
                                setAccessToken(response.access_token);
                                setIsAuthenticated(true);
                                setMessage({ type: 'success', text: 'Successfully signed in!' });
                            }
                        },
                    });
                };

                // Load gapi client
                const loadGapi = () => {
                    gapi.load('client', async () => {
                        await gapi.client.init({
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/admin/directory_v1/rest'],
                        });
                        initializeGIS();
                    });
                };

                if (window.gapi) {
                    loadGapi();
                } else {
                    window.addEventListener('load', loadGapi);
                }
            }, []);

            const handleSignIn = () => {
                if (window.tokenClient) {
                    window.tokenClient.requestAccessToken({ prompt: 'consent' });
                }
            };

            const handleSignOut = () => {
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken, () => {
                        setAccessToken(null);
                        setIsAuthenticated(false);
                        setMembers([]);
                        setMessage({ type: 'success', text: 'Signed out successfully' });
                    });
                }
            };

            const fetchMembers = async () => {
                if (!accessToken) return;
                
                setLoading(true);
                setMessage({ type: '', text: '' });
                
                try {
                    gapi.client.setToken({ access_token: accessToken });
                    const response = await gapi.client.directory.members.list({
                        groupKey: GROUP_EMAIL
                    });
                    
                    setMembers(response.result.members || []);
                    setMessage({ type: 'success', text: `Loaded ${response.result.members?.length || 0} members` });
                } catch (error) {
                    setMessage({ type: 'error', text: 'Failed to fetch members. Please ensure you have admin permissions.' });
                    console.error(error);
                }
                
                setLoading(false);
            };

            const addMembers = async () => {
                if (!emailInput.trim()) {
                    setMessage({ type: 'error', text: 'Please enter at least one email address' });
                    return;
                }

                const emails = emailInput.split(/[,\n]/).map(e => e.trim()).filter(e => e);
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const invalidEmails = emails.filter(e => !emailRegex.test(e));

                if (invalidEmails.length > 0) {
                    setMessage({ type: 'error', text: `Invalid email(s): ${invalidEmails.join(', ')}` });
                    return;
                }

                setLoading(true);
                let successCount = 0;
                let failCount = 0;

                gapi.client.setToken({ access_token: accessToken });

                for (const email of emails) {
                    try {
                        await gapi.client.directory.members.insert({
                            groupKey: GROUP_EMAIL,
                            resource: {
                                email: email,
                                role: 'MEMBER'
                            }
                        });
                        successCount++;
                    } catch (error) {
                        failCount++;
                        console.error(`Failed to add ${email}:`, error);
                    }
                }

                setMessage({ 
                    type: successCount > 0 ? 'success' : 'error', 
                    text: `Added ${successCount} member(s). ${failCount > 0 ? `Failed: ${failCount}` : ''}` 
                });
                
                setEmailInput('');
                await fetchMembers();
                setLoading(false);
            };

            const removeMember = async (email) => {
                if (!confirm(`Remove ${email} from the group?`)) return;

                setLoading(true);
                
                try {
                    gapi.client.setToken({ access_token: accessToken });
                    await gapi.client.directory.members.delete({
                        groupKey: GROUP_EMAIL,
                        memberKey: email
                    });
                    
                    setMessage({ type: 'success', text: `Removed ${email}` });
                    await fetchMembers();
                } catch (error) {
                    setMessage({ type: 'error', text: `Failed to remove ${email}` });
                    console.error(error);
                }
                
                setLoading(false);
            };

            useEffect(() => {
                if (isAuthenticated && accessToken) {
                    fetchMembers();
                }
            }, [isAuthenticated, accessToken]);

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
                            <div className="flex justify-center mb-4"><Users /></div>
                            <h1 className="text-2xl font-bold text-gray-800 mb-2">Google Group Manager</h1>
                            <p className="text-gray-600 mb-6">Manage Client Onboarding group membership</p>
                            <button
                                onClick={handleSignIn}
                                className="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                            >
                                Sign in with Google
                            </button>
                            {message.text && message.type === 'success' && (
                                <div className="mt-4 text-green-600 text-sm">
                                    {message.text}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                            <div className="flex justify-between items-center mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800">Google Group Manager</h1>
                                    <p className="text-gray-600 mt-1">Client Onboarding @ progroupmail.com</p>
                                </div>
                                <button
                                    onClick={handleSignOut}
                                    className="text-gray-600 hover:text-gray-800 text-sm underline"
                                >
                                    Sign Out
                                </button>
                            </div>

                            {message.text && (
                                <div className={`flex items-center gap-2 p-4 rounded-lg mb-6 ${
                                    message.type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'
                                }`}>
                                    {message.type === 'success' ? <CheckCircle /> : <AlertCircle />}
                                    <span>{message.text}</span>
                                </div>
                            )}

                            <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Add Email Address(es)
                                </label>
                                <textarea
                                    value={emailInput}
                                    onChange={(e) => setEmailInput(e.target.value)}
                                    placeholder="Enter email addresses (comma or newline separated)&#10;Example: john@example.com, jane@example.com"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                                    rows="3"
                                />
                                <button
                                    onClick={addMembers}
                                    disabled={loading || !emailInput.trim()}
                                    className="mt-3 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                                >
                                    {loading ? <Loader2 /> : <UserPlus />}
                                    Add to Group
                                </button>
                            </div>

                            <div className="border-t pt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-semibold text-gray-800">Current Members ({members.length})</h2>
                                    <button
                                        onClick={fetchMembers}
                                        disabled={loading}
                                        className="text-indigo-600 hover:text-indigo-700 text-sm font-medium flex items-center gap-1"
                                    >
                                        {loading ? <Loader2 /> : 'â†»'} Refresh
                                    </button>
                                </div>

                                {members.length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">No members in this group</p>
                                ) : (
                                    <div className="space-y-2">
                                        {members.map((member) => (
                                            <div
                                                key={member.id}
                                                className="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                                            >
                                                <div>
                                                    <p className="font-medium text-gray-800">{member.email}</p>
                                                    <p className="text-xs text-gray-500">{member.role}</p>
                                                </div>
                                                <button
                                                    onClick={() => removeMember(member.email)}
                                                    disabled={loading}
                                                    className="text-red-600 hover:text-red-700 disabled:text-gray-400 p-2 rounded-lg hover:bg-red-50 transition-colors"
                                                >
                                                    <UserMinus />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GoogleGroupManager />, document.getElementById('root'));
    </script>
</body>
</html>
